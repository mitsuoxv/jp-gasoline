---
title: "Gasoline prices in Japan"
author: "Mitsuo Shiota"
date: "2021-11-17"
output: 
  github_document:
    toc: TRUE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(tidyverse)
library(readxl)
library(tsibble)
library(fable)
library(lubridate)
library(pdftools)
library(patchwork)
library(tidyquant)
```

Updated: `r Sys.Date()`

## Summary

[Nikkei reported](https://www.nikkei.com/article/DGXZQOUA169350W1A111C2000000/) on November 17, 2021 that Ministry of Economy, Trade and Industry (METI) is considering a subsidy to gasoline wholesalers to suppress gasoline retail prices when they rise to higher than 170 yen per litre. At the end of the article, Nikkei showed a skeptical view saying, "As the number of retailers has decreased, the retailers may not reduce retail prices even if wholesale prices fall." So I study the relationship among retail and wholesale prices of gasoline and imported crude oil prices in Japan.

I find the current surge in retail prices of gasoline is mainly due to the surge in imported crude oil prices, and partly due to the reduced competition among retailers and wholesalers, who are getting more margins.

To give a subsidy to wholesalers may incentivize them to raise their margins even more. This subsidy idea is contrary to that of the Biden Administration, which has begun to investigate oil companies.

## Get gasoline prices

Agency for National Resources Energy under METI publishes gasoline prices in its [web site](https://www.enecho.meti.go.jp/statistics/petroleum_and_lpgas/pl007/results.html#headline1). Although the original retail price data include consumption tax since April 1, 2004, I exclude consumption tax all over the period.

```{r get_data, message=FALSE}

wholesale <- read_excel("data/220428o5.xls",
                        sheet = "レギュラー",
                        col_types = c("text", "date", rep("text", 55))
                        ) %>% 
  select(date = "調査年月", price = "全         国") %>% 
  mutate(
    date = as.Date(date),
    price = as.numeric(price)
    ) 

wholesale_price <- wholesale %>% 
  mutate(month = yearmonth(date)) %>% 
  select(month, wholesale_price = price) %>% 
  as_tsibble(index = month)

retail <- read_excel("data/220511s5.xls", 
                     sheet = "レギュラー",
                        col_types = c("text", "date", rep("text", 59)))

retail <- retail %>% 
  slice_head(n = nrow(retail) - 1) %>% 
  select(date = "調査日", price = "全         国") %>% 
  mutate(
    date = as.Date(date),
    price = as.numeric(price)
    ) 

retail_price <- retail %>% 
  mutate(
    tax_rate = case_when(
      date < "2004-04-01" ~ 0,
      date < "2014-04-01" ~ .05,
      date < "2019-10-01" ~ .08,
      TRUE ~ .1
                       ),
    price_excl_tax = price / (1 + tax_rate)
  )

retail_price_month <- retail_price %>% 
  select(date, retail_price = price_excl_tax) %>% 
  as_tsibble(index = date) %>% 
  index_by(month = yearmonth(date)) %>% 
  summarize(retail_price = mean(retail_price))

```

I get imported crude oil price data from customs statistics via [e-Stat](https://www.e-stat.go.jp/stat-search/files?page=1&layout=datalist&toukei=00350300&bunya_l=16&tstat=000001013141&cycle=1&tclass1=000001013192&tclass2=000001013194&tclass3val=0).

```{r get_crude_from_csv, message=FALSE}

get_crude_oil_price <- function(df) {
  df %>% 
    mutate(Commodity =  str_remove_all(Commodity, "'| ")) %>% 
    filter(Commodity == "30301") %>% 
    pivot_longer(!("Exp or Imp":Unit), names_to = c(".value", "month"),
                 names_pattern = "^(\\w+)\\-(\\w+)$") %>% 
    filter(month != "Year") %>% 
    mutate(
      month = if_else(month == "Apl", "Apr", month),
      date = dmy(paste(1, month, Year)),
      crude_oil_price = Value / Quantity
    ) %>% 
    select(date, crude_oil_price)
}

import <- paste0("data/", dir("data/", ".csv")) %>% 
  map(~ read_csv(.x) %>% get_crude_oil_price) %>% 
  bind_rows() %>% 
  filter(!is.na(crude_oil_price))

```

```{r get_crude_from_pdf, eval=FALSE}

get_from_pdf <- function(id) {
  paste0("https://www.e-stat.go.jp/stat-search/file-download?statInfId=00000", id, "&fileKind=2") %>% 
    pdf_text() %>% 
    read_csv() %>% 
    setNames(c("line")) %>% 
    filter(str_detect(line, "^\\d")) %>% 
    pull(line) %>% 
    paste(collapse = "\n") %>% 
    read_fwf(col_positions = fwf_widths(c(23, 2, 15, 17, 17, 11)),
             col_types = cols(.default = col_character())) %>% 
    mutate(statInfId = id)
}

id_date <- tibble(
  statInfId = c("2356861", "2360681", "2366821", # 2001
               "2370903", "2374447", "2377215",
               "2388625", "2395224", "2400500",
               "2403671", "2409041", "2413944",
               "2353533", "2368407", "2373904", # 2002
               "2390257", "2397348", "2406335",
               "2414755", "2419894", "2434540",
               "2462003", "2477263", "2487568",
               "2154280", "2159214", "2167204", # 2003
               "2172358", "2182731", "2187465",
               "2192337", "2196921", "2203979",
               "2206662", "2210342", "2214409",
               "2154829", "2163290", "2170020", # 2004
               "2176027", "2184517", "2193631",
               "2212517", "2216694", "2224086",
               "2243822", "2253031", "2263407",
               "2221012", "2225946", "2228322", # 2005
               "2231036", "2234710", "2238784",
               "2243156", "2248685", "2251982",
               "2254626", "2257154", "2263286",
               "2070609", "2073232", "2075826", # 2006
               "2078138", "2080876", "2084239",
               "2086779", "2089357", "2091820",
               "2094179", "2096541", "2099394",
               "2101765", "2104568", "2107778", # 2007
               "2110529", "2113720", "2116186",
               "2119134", "2122199", "2125080",
               "2127655", "2130968", "2133192",
               "2524275", "2524925", "2525183", # 2008
               "2525808", "2526624", "2527557",
               "2528619", "2530117", "2530804", 
               "2534412", "2531505", "2532132"
               ),
  date = map(2001:2008, ~ make_date(year = .x, month = 1:12)) %>% 
      unlist() %>% 
      as.Date(origin = "1970-01-01")
)

import_pdf <- map(id_date$statInfId, ~ get_from_pdf(.x)) %>% 
  bind_rows() %>% 
  left_join(id_date, by = "statInfId")

save(import_pdf, file = "data/import_from_pdf.rda")

```

```{r load_pdf_data}

load(file = "data/import_from_pdf.rda")

```

```{r combine}

import_price <- import_pdf %>% 
  filter(X1 == "30301") %>% 
  select(date, quantity = X3, value = X4) %>% 
  mutate(
    across(quantity:value, as.numeric),
    crude_oil_price = value / quantity
    ) %>% 
  select(date, crude_oil_price) %>% 
  bind_rows(import)  %>% 
  mutate(month = yearmonth(date)) %>% 
  as_tsibble(index = month) %>% 
  select(-date)

combo <- retail_price_month %>% 
  filter_index("2000 Jul" ~ .) %>% 
  left_join(wholesale_price, by = "month") %>% 
  left_join(import_price, by = "month") %>% 
  mutate(
    crude_plus_tax = crude_oil_price + 53.8,
    diff_rw = retail_price - wholesale_price,
    diff_wc = wholesale_price - crude_plus_tax
    ) %>% 
  pivot_longer(retail_price:diff_wc) %>% 
  update_tsibble(key = name)

```

## Plot retail, wholesale gas and crude oil prices

Yes, both retail and wholesale prices are rising, mainly due to rising imported crude oil prices.

```{r plot1, warning=FALSE}

combo %>% 
  filter(name %in% c("retail_price", "wholesale_price", "crude_plus_tax")) %>% 
  autoplot(value) +
  geom_hline(yintercept = 170/1.1, color = "gray50") +
  annotate("text", x = yearmonth("2010 Jan"), y = 160, label = "155 (170 including consumption tax)", size = 4) +
  geom_hline(yintercept = 53.8, color = "gray50") +
  geom_text(aes(label = month(month, label = TRUE)),
            data = combo %>% 
              filter(!is.na(value)) %>% 
              filter(name == "retail_price") %>% 
              tail(1),
            hjust = 1, vjust = -0.5) +
  geom_text(aes(label = month(month, label = TRUE)),
            data = combo %>% 
              filter(!is.na(value)) %>% 
              filter(name == "wholesale_price") %>% 
              tail(1),
            hjust = 1, vjust = -0.5) +
  geom_text(aes(label = month(month, label = TRUE)),
            data = combo %>% 
              filter(!is.na(value)) %>% 
              filter(name == "crude_plus_tax") %>% 
              tail(1),
            hjust = 1, vjust = -0.5) +
  annotate("text", x = yearmonth("2010 Jan"), y = 59, label = "53.8 gasoline tax", size = 4) +
  annotate("text", x = yearmonth("2000 Jan"), y = 110, label = "Retail", size = 4) +
  annotate("text", x = yearmonth("2001 Jan"), y = 90, label = "Wholesale", size = 4) +
  annotate("text", x = yearmonth("2003 Jan"), y = 70, label = "Crude oil (right axis)", size = 4) +expand_limits(y = 0) +
  scale_y_continuous(
    name = "Yen per litre\n(excluding consumption tax)",
    sec.axis = sec_axis(~ .x - 53.8)
  ) +
  labs(title = "Gasoline and crude oil prices in Japan") +
  theme(legend.position = "none")

```

```{r wholesale_vs_crude, warning=FALSE}

wholesale_crude <- combo %>% 
  filter(name %in% c("wholesale_price", "crude_plus_tax")) %>% 
  pivot_wider(names_from = name, values_from = value) %>% 
  na.omit()

p_1c <- wholesale_crude %>% 
  ggplot(aes(lead(crude_plus_tax), wholesale_price)) +
  geom_point(alpha = 0.2) +
  coord_fixed()

p0c <- wholesale_crude %>% 
  ggplot(aes(crude_plus_tax, wholesale_price)) +
  geom_point(alpha = 0.2) +
  coord_fixed()

p1c <- wholesale_crude %>% 
  ggplot(aes(lag(crude_plus_tax), wholesale_price)) +
  geom_point(alpha = 0.2) +
  coord_fixed()

p_1c | p0c | p1c

```

Correlations are `r cor(wholesale_crude$crude_plus_tax[-1], wholesale_crude$wholesale_price[-nrow(wholesale_crude)]) %>% round(4)` if wholesales lead Japan customs by 1 month, `r cor(wholesale_crude$crude_plus_tax, wholesale_crude$wholesale_price) %>% round(4)` if wholesales is concurrent with Japan customs, and `r cor(wholesale_crude$crude_plus_tax[-nrow(wholesale_crude)], wholesale_crude$wholesale_price[-1]) %>% round(4)` if wholesales lag Japan customs by 1 month. The highest correlation is if wholesales is concurrent with Japan customs.

## Plot price differences

Differences between retail and wholesale prices have been increasing since 2016. The average difference was `r combo %>% filter(name == "diff_rw") %>% filter_index("2000 Jul" ~ "2015 Dec") %>% pull(value) %>% mean() %>% round()` yen per litre from 2000 Jul to 2015 Dec, and is `r combo %>% filter(name == "diff_rw", !is.na(value)) %>% slice_tail(n = 1) %>% pull(value) %>% round()` in `r combo %>% filter(name == "diff_rw", !is.na(value)) %>% slice_tail(n = 1) %>% pull(month)`. This may reflect the reduced competition among retailers. You can see the number of retailers has constantly decreased since around 1995 in the last page of [this material (Japanese)](https://www.enecho.meti.go.jp/category/resources_and_fuel/distribution/hinnkakuhou/data/2021_07_30_01.pdf) from Agency for National Resources Energy.

```{r plot 2, warning=FALSE}

combo %>% 
  filter(name == "diff_rw") %>% 
  autoplot(value) +
  geom_text(aes(label = month(month, label = TRUE)),
            data = combo %>% 
              filter(!is.na(value)) %>% 
              filter(name == "diff_rw") %>% 
              tail(1),
            hjust = -0.2, vjust = 0) +
  expand_limits(y = 0) +
  labs(y = "Yen per litre",
       title = "Differences between retail and wholesale prices")

```

Differences between wholesale price and imported crude oil price plus gasoline tax have also been increasing. The average difference was `r combo %>% filter(name == "diff_wc") %>% filter_index("2001 Jan" ~ "2014 Dec") %>% pull(value) %>% mean() %>% round()` yen per litre from 2001 Jan to 2014 Dec, and is `r combo %>% filter(name == "diff_wc", !is.na(value), month == yearmonth("2022 Jan")) %>%  pull(value) %>% round()` in 2022 Jan. This may reflect the reduced competition among wholesalers, who have got monopolistic power by consolidation.

```{r plot3, warning=FALSE}

combo %>% 
  filter(name == "diff_wc") %>% 
  autoplot(value) +
  geom_text(aes(label = month(month, label = TRUE)),
            data = combo %>% 
              filter(!is.na(value)) %>% 
              filter(name == "diff_rw") %>% 
              tail(1),
            hjust = -0.2, vjust = 0) +
  labs(y = "Yen per litre",
       title = "Differences between wholesale price and\nimported crude oil price + gasoline tax")

```

It was `r combo %>% filter(name == "diff_wc", !is.na(value), month == yearmonth("2022 Feb")) %>%  pull(value) %>% round()` in 2022 Feb, and failed to drop as much as 5 yen per litre subsidy. It was `r combo %>% filter(name == "diff_wc", !is.na(value), month == yearmonth("2022 Mar")) %>%  pull(value) %>% round()` in 2022 Mar, and failed to drop significantly, although 20-25 yen per litre subsidy was given to wholesalers in March.

```{r recent_diff_wc}

combo %>% 
  filter(name == "diff_wc", !is.na(value)) %>% 
  select(-name) %>% 
  slice_tail(n = 5)

```

## Dubai crude oil price (monthly)

### vs Japan customs import price

Import prices pretty precisely follow Dubai crude oil spot prices of one month ago.

```{r get_dubai_data}

dub_oil <- tq_get(c("POILDUBUSDM", "EXJPUS"), get = "economic.data", from = "1990-01-01")

dub_oil_month <- dub_oil %>% 
  pivot_wider(names_from = symbol, values_from = price) %>% 
  mutate(dub_oil_price = POILDUBUSDM * EXJPUS / 158.99) %>% 
  select(date, dub_oil_price) %>% 
  mutate(month = yearmonth(date)) %>% 
  as_tsibble(index = month) %>% 
  select(-date)
```

```{r dub_import, warning=FALSE}

dub_import <- dub_oil_month %>% 
  inner_join(import_price, by = "month") %>% 
  rename(import_price = crude_oil_price) %>% 
  filter(!is.na(dub_oil_price), !is.na(import_price))

p0 <- dub_import %>% 
  ggplot(aes(dub_oil_price, import_price)) +
  geom_point(alpha = 0.2) +
  coord_fixed()

p1 <- dub_import %>% 
  ggplot(aes(lag(dub_oil_price, 1), import_price)) +
  geom_point(alpha = 0.2) +
  coord_fixed()

p2 <- dub_import %>% 
  ggplot(aes(lag(dub_oil_price, 2), import_price)) +
  geom_point(alpha = 0.2) +
  coord_fixed()

p0 | p1 | p2

```

Correlations are `r cor(dub_import$dub_oil_price, dub_import$import_price) %>% round(4)` if 0 month lag from Dubai to Japan customs, `r cor(dub_import$dub_oil_price[-251], dub_import$import_price[-1]) %>% round(4)` if 1 month lag, and `r cor(dub_import$dub_oil_price[c(-nrow(dub_import) + 1, -nrow(dub_import))], dub_import$import_price[c(-1, -2)]) %>% round(4)` if 2 months lag. The highest correlation is if Japan customs lag Dubai by 1 month.

### vs wholesale gasoline price

```{r dub_wholesale, warning=FALSE}

dub_import_wholesale <- wholesale_price %>% 
  inner_join(dub_oil_month, by = "month") %>% 
  filter(!is.na(dub_oil_price), !is.na(wholesale_price)) %>% 
  filter(month >= yearmonth("2001 Jan"))

p0w <- dub_import_wholesale %>% 
  ggplot(aes(dub_oil_price, wholesale_price)) +
  geom_point(alpha = 0.2) +
  coord_fixed()

p1w <- dub_import_wholesale %>% 
  ggplot(aes(lag(dub_oil_price, 1), wholesale_price)) +
  geom_point(alpha = 0.2) +
  coord_fixed()

p2w <- dub_import_wholesale %>% 
  ggplot(aes(lag(dub_oil_price, 2), wholesale_price)) +
  geom_point(alpha = 0.2) +
  coord_fixed()

p0w | p1w | p2w

```

Wholesale prices follow Dubai crude oil prices of one month ago. Correlations are `r cor(dub_import_wholesale$dub_oil_price, dub_import_wholesale$wholesale_price) %>% round(4)` if 0 month lag from Dubai to wholesalers, `r cor(dub_import_wholesale$dub_oil_price[-nrow(dub_import_wholesale)], dub_import_wholesale$wholesale_price[-1]) %>% round(4)` if 1 month lag, and `r cor(dub_import_wholesale$dub_oil_price[c(-nrow(dub_import_wholesale) + 1, -nrow(dub_import_wholesale))], dub_import_wholesale$wholesale_price[c(-1, -2)]) %>% round(4)` if 2 months lag. The highest correlation is if wholesales lag Dubai by 1 month.

### vs retail gasoline price

```{r dub_retail, warning=FALSE}

dub_import_retail <- retail_price_month %>% 
  mutate(retail_price = 1.1 * retail_price) %>% # include 10 percent consumption tax
  inner_join(dub_oil_month, by = "month") %>% 
  filter(!is.na(dub_oil_price), !is.na(retail_price)) %>% 
  filter(month >= yearmonth("2001 Jan"))

p0r <- dub_import_retail %>% 
  ggplot(aes(dub_oil_price, retail_price)) +
  geom_point(alpha = 0.2) +
  coord_fixed()

p1r <- dub_import_retail %>% 
  ggplot(aes(lag(dub_oil_price, 1), retail_price)) +
  geom_point(alpha = 0.2) +
  coord_fixed()

p2r <- dub_import_retail %>% 
  ggplot(aes(lag(dub_oil_price, 2), retail_price)) +
  geom_point(alpha = 0.2) +
  coord_fixed()

p0r | p1r | p2r

```

Retail prices (including constant 10 percent consumption tax) also follow Dubai crude oil prices of one month ago. Correlations are `r cor(dub_import_retail$dub_oil_price, dub_import_retail$retail_price) %>% round(4)` if 0 month lag from Dubai to Japan customs, `r cor(dub_import_retail$dub_oil_price[-nrow(dub_import_retail)], dub_import_retail$retail_price[-1]) %>% round(4)` if 1 month lag, and `r cor(dub_import_retail$dub_oil_price[c(-nrow(dub_import_retail) + 1, -nrow(dub_import_retail))], dub_import_retail$retail_price[c(-1, -2)]) %>% round(4)` if 2 months lag. The highest correlation is if retails lag Dubai by 1 month.

```{r dub_import_retail_diff}

dub_import_retail_diff <- dub_import_retail %>% 
  mutate(
    dub_oil_price_lag = lag(dub_oil_price),
    diff = retail_price - dub_oil_price_lag
  ) %>% 
  filter(!is.na(diff))

dub_import_retail_diff %>% 
  autoplot(diff) +
  geom_text(aes(label = round(diff, 0)), 
            vjust = 0, hjust = 0,
            data = dub_import_retail_diff %>% tail(1)) +
  labs(y = "Yen per litre",
       title = "Difference between retail price (including constant 10 percent\nconsumption tax) and one month ago Dubai crude oil price")

```

The most recent difference between retail price (including constant 10 percent\\nconsumption tax) and one month ago Dubai crude oil price is `r dub_import_retail_diff %>% tail(1) %>% pull(diff) %>% round(2)` at `r dub_import_retail_diff %>% tail(1) %>% pull(month) %>% as.character()`

## Dubai crude oil price (weekly)

I get daily data from [oilprice.com](https://oilprice.com/jp/%E5%8E%9F%E6%B2%B9%E4%BE%A1%E6%A0%BC%E3%83%81%E3%83%A3%E3%83%BC%E3%83%88).

```{r get_daily_dubai}

dubai_daily <- tribble(
  ~date, ~price,
  "2021-11-22", 80.548,
  "2021-11-24", 81.201,
  "2021-11-26", 80.084,
  "2021-11-29", 80.305,
  "2021-11-30", 80.276,
  "2021-12-02", 80.276,
  "2021-12-03", 68.909,
  "2021-12-06", 71.654,
  "2021-12-08", 73.693,
  "2021-12-10", 73.189,
  "2021-12-14", 72.223,
  "2021-12-15", 72.383,
  "2021-12-17", 72.432,
  "2021-12-20", 71.655,
  "2021-12-22", 72.71,
  "2021-12-27", 73.2,
  "2021-12-30", 73.19,
  "2021-12-31", 73.185,
  "2022-01-03", 73.185,
  "2022-01-04", 73.185,
  "2022-01-05", 78.812,
  "2022-01-06", 79.695,
  "2022-01-07", 79.535,
  "2022-01-07", 79.535,
  "2022-01-10", 78.887,
  "2022-01-11", 80.789,
  "2022-01-12", 81.342,
  "2022-01-13", 81.297,
  "2022-01-14", 82.269,
  "2022-01-18", 83.221,
  "2022-01-19", 83.559,
  "2022-01-20", 83.496,
  "2022-01-21", 83.291,
  "2022-01-24", 82.868,
  "2022-01-25", 83.213,
  "2022-01-26", 83.389,
  "2022-01-27", 83.333,
  "2022-01-28", 83.362,
  "2022-01-31", 83.455,
  "2022-02-01", 83.455,
  "2022-02-04", 91.056,
  "2022-02-07", 90.757,
  "2022-02-08", 89.282,
  "2022-02-09", 89.883,
  "2022-02-10", 89.918,
  "2022-02-11", 91.79,
  "2022-02-14", 92.605,
  "2022-02-15", 90.859,
  "2022-02-16", 91.558,
  "2022-02-18", 90.897,
  "2022-02-22", 91.838,
  "2022-02-24", 92.074,
  "2022-02-25", 91.928,
  "2022-02-28", 92.34,
  "2022-03-01", 92.34,
  "2022-03-02", 92.34,
  "2022-03-03", 106.578,
  "2022-03-04", 114.95,
  "2022-03-07", 118.18,
  "2022-03-08", 122.532,
  "2022-03-09", 110.86
) %>% 
  mutate(date = as.Date(date))

yen_dollar_daily <- tq_get(c("DEXJPUS"), get = "economic.data", from = "2020-01-01") %>% 
  select(-symbol)

yen_dollar_daily <- yen_dollar_daily %>% 
  rename(yen_dollar_rate = price)

dubai_daily2 <- dubai_daily %>% 
  left_join(yen_dollar_daily, by = "date") %>% 
  mutate(dubai_oil_price = price * yen_dollar_rate / 158.99) %>% 
  select(date, dubai_oil_price)

dubai_weekly <- dubai_daily2 %>% 
  mutate(week = yearweek(date)) %>% 
  group_by(week) %>% 
  summarize(price = mean(dubai_oil_price, na.rm = TRUE))

```

[METI publishes](https://nenryo-gekihenkanwa.jp/pdf/result_rev8.pdf) Dubai crude oil prices, counterfactual gasoline prices without subsidies, actual gasoline prieces and effects of subsidies, which are differences between counterfacual and actual, all in the units of yen / litre every week.

```{r meti_calc}

meti_dubai_weekly <- tribble(
  ~start_date, ~price,
  "2022-01-03", 57.8,
  "2022-01-10", 59.4,
  "2022-01-17", 62.6,
  "2022-01-24", 62.9,
  "2022-01-31", 64.4,
  "2022-02-07", 66.2,
  "2022-02-14", 67.4,
  "2022-02-22", 69.9,
  "2022-03-01", 81.6,
  "2022-03-08", 85.8,
  "2022-03-15", 76.8,
  "2022-03-22", 88,
  "2022-03-29", 81.6,
  "2022-04-05", 79.2,
  "2022-04-12", 83.6,
  "2022-04-19", 85.6,
  "2022-04-26", 85.4,
  "2022-05-03", 85.4
) %>% 
  mutate(week = yearweek(start_date)) %>% 
  select(-start_date)

meti_subsidy <- tribble(
  ~start_date, ~subsidy,
  "2022-01-17", 3.4,
  "2022-01-24", 3.7,
  "2022-01-31", 5,
  "2022-02-07", 5,
  "2022-02-14", 5,
  "2022-02-22", 5,
  "2022-03-01", 17.7,
  "2022-03-08", 25,
  "2022-03-15", 18.6,
  "2022-03-22", 25,
  "2022-03-29", 20.7,
  "2022-04-05", 20.3,
  "2022-04-12", 25,
  "2022-04-19", 31.8,
  "2022-04-26", 34.7,
  "2022-05-03", 34.7
) %>% 
  mutate(week = yearweek(start_date)) %>% 
  select(-start_date)
```

Weekly prices are not so different between oilprice.com and METI.

```{r dubai_chart}

dubai_weekly %>% 
  mutate(source = "oilprice.com") %>% 
  bind_rows(meti_dubai_weekly %>% mutate(source = "METI")) %>% 
  ggplot(aes(week, price, color = source)) +
  geom_line() +
  scale_x_yearweek(date_labels = "%b %d") +
  labs(x = NULL, y = "Yen per liter", color = "Data source",
       title = "Dubai crude oil prices (weekly)")
```

So I create weekly prices data by combining oilprice.com in 2021 and METI in 2022.

```{r dubai_weekly}

dubai_weekly2 <- dubai_weekly %>% 
  filter(year(week) == 2021) %>% 
  bind_rows(meti_dubai_weekly %>% filter(year(week) == 2022)) %>% 
  rename(dubai = price)

retail_price_weekly <- retail_price %>% 
  bind_rows(
    tibble(date = as.Date("2022-05-02"))
  ) %>% 
  arrange(date) %>% 
  fill(price:price_excl_tax, .direction = "up") %>%
  mutate(
    week = yearweek(date),
    price = 1.1 * price_excl_tax # include constant 10 percent consumption tax
    ) %>% 
  select(week, actual = price) %>% 
  left_join(dubai_weekly2, by = "week") %>% 
  left_join(meti_subsidy, by = "week")

effect_by_lag <- function(lag) {
  retail_price_weekly %>% 
    mutate(
      dubai_lag_n = lag(dubai, lag),
      diff_retail_crude = actual[week == yearweek("2022 W04")] - 
        dubai_lag_n[week == yearweek("2022 W04")],
      counterfactual_wo_subsidy = dubai_lag_n + diff_retail_crude,
      effect_by_subsidy = counterfactual_wo_subsidy - actual,
      subsidy_lag = lag(subsidy, 2),
      subsidy_lag = replace_na(subsidy_lag, 0),
      counterfactual_with_subsidy = counterfactual_wo_subsidy - subsidy_lag
      ) %>% 
    filter(week >= yearweek("2022 W02"))
}

effects <- map_dfr(0:5, effect_by_lag, .id = "lag") %>% 
  mutate(
    lag = as.numeric(lag),
    lag = lag - 1
  )

```

METI calculates subsidy effects on retail prices by assuming that retail prices will reflect subsidies 2 weeks later. I have no reason to disagree.

METI also assumes that there is 2 weeks lag between Dubai crude oil prices and retail prices (0 week from Dubai to wholesalers and 2 weeks from wholesalers to retailers). I disagree. In the physical terms, it is impossible to carry oil from Dubai to retailers in Japan in 2 weeks. In the accounting terms, all major wholesalers evaluate stocks by average method, not by LIFO (Last In First Out). In the past observations from the monthly data, wholesale prices usually lag Dubai crude oil prices by 1 month.

If we assume 3 weeks lag instead, subsidy effects are smaller. When effects are smaller than subsidies, subsidies are not fully reflected in retail prices, and wholesalers and/or retailers are getting benefits from subsidies.

```{r actual_counterfactual}

effects %>% 
  pivot_longer(c(actual, counterfactual_with_subsidy, counterfactual_wo_subsidy)) %>% 
  mutate(
    name = recode(name,
                  actual = "Actual prices",
                  counterfactual_wo_subsidy = "Counterfactual prices\nif no subsidy",
                  counterfactual_with_subsidy = "Prices if subsidies are\nfully reflected")
  ) %>% 
  ggplot(aes(week, value, color = name)) +
  geom_line() +
  scale_x_yearweek(date_labels = "%m/\n%d") +
  facet_wrap(vars(lag)) +
  labs(x = NULL, y = "Yen per litre", color = NULL,
       title = "Actual and counterfactual retail prices\nby # of week lags from Dubai to retail")

```

```{r subsidy_effect, warning=FALSE}

effects %>% 
  group_by(lag) %>% 
  mutate(
    subsidy = lag(subsidy, 2),
    subsidy = replace_na(subsidy, 0)
  ) %>% 
  ungroup() %>% 
  pivot_longer(c(subsidy, effect_by_subsidy)) %>% 
  mutate(
    name = recode(name,
                  effect_by_subsidy = "Effect",
                  subsidy = "Subsidy")
  ) %>% 
  filter(week >= yearweek("2022 W05")) %>% 
  ggplot(aes(week, value, fill = name)) +
  geom_col(position = "identity", alpha = 0.5) +
  scale_fill_manual(values = c("red", "blue")) +
  scale_x_yearweek(date_labels = "%m/\n%d") +
  facet_wrap(vars(lag)) +
  labs(x = NULL, y = "Yen per litre", fill = NULL,
       title = "Effect of subsidies by # of week lags from Dubai to retail")

```

```{r normal_margin}

normal_margin <- retail_price_weekly %>% 
  mutate(
    normal_diff = actual[week == yearweek("2022 W04")] - dubai
    ) %>% 
  filter(week >= yearweek("2021 W50"),
         week <= yearweek("2022 W04")) %>% 
  pull(normal_diff) %>% 
  rev()

```

Above calculation assumes there is a constant margin between Dubai crude oil prices and retail prices. Lag 0 to 5 assumes margins `r normal_margin %>% round(1)` respectively.

Lag 2 assumes `r normal_margin[3] %>% round(1)`, and it is close to the most recent monthly margin `r dub_import_retail_diff %>% tail(1) %>% pull(diff) %>% round(2)` at `r dub_import_retail_diff %>% tail(1) %>% pull(month) %>% as.character()`. Let us assume this margin of `r normal_margin[3] %>% round(1)` over all lags between Dubai crude oil prices and retail prices.

```{r effect_by_lag2}

effect_by_lag2 <- function(lag) {
  retail_price_weekly %>% 
    mutate(
      dubai_lag_n = lag(dubai, lag),
      diff_retail_crude = normal_margin[3],
      counterfactual_wo_subsidy = dubai_lag_n + diff_retail_crude,
      effect_by_subsidy = counterfactual_wo_subsidy - actual,
      subsidy_lag = lag(subsidy, 2),
      subsidy_lag = replace_na(subsidy_lag, 0),
      counterfactual_with_subsidy = counterfactual_wo_subsidy - subsidy_lag
    ) %>% 
    filter(week >= yearweek("2022 W02"))
}

effects2 <- map_dfr(0:5, effect_by_lag2, .id = "lag") %>% 
  mutate(
    lag = as.numeric(lag),
    lag = lag - 1
  )
```

```{r actual_counterfactual2}

effects2 %>% 
  pivot_longer(c(actual, counterfactual_with_subsidy, counterfactual_wo_subsidy)) %>% 
  mutate(
    name = recode(name,
                  actual = "Actual prices",
                  counterfactual_wo_subsidy = "Counterfactual prices\nif no subsidy",
                  counterfactual_with_subsidy = "Prices if subsidies are\nfully reflected")
  ) %>% 
  ggplot(aes(week, value, color = name)) +
  geom_line() +
  scale_x_yearweek(date_labels = "%m/\n%d") +
  facet_wrap(vars(lag)) +
  labs(x = NULL, y = "Yen per litre", color = NULL,
       title = "Actual and counterfactual retail prices\nby # of week lags from Dubai to retail\nassuming fixed margin across all lags")

```

```{r subsidy_effect2, warning=FALSE}

effects2 %>% 
  pivot_longer(c(subsidy_lag, effect_by_subsidy)) %>% 
  mutate(
    name = recode(name,
                  effect_by_subsidy = "Effect",
                  subsidy_lag = "Subsidy")
  ) %>% 
  filter(week >= yearweek("2022 W05")) %>% 
  ggplot(aes(week, value, fill = name)) +
  geom_col(position = "identity", alpha = 0.5) +
  scale_fill_manual(values = c("red", "blue")) +
  scale_x_yearweek(date_labels = "%m/\n%d") +
  facet_wrap(vars(lag)) +
  labs(x = NULL, y = "Yen per litre", fill = NULL,
       title = "Effect of subsidies by # of week lags from Dubai to retail\nassuming fixed margin across all lags")

```

As I assume fixed margin based on lag 2 assumption, lag 2 does not change from the previous plots. In lags 3 to 5, there are less effects of subsidies than the previous plots.

From this analysis, it is clear that the assumption on lag and normal margin between Dubai crude oil prices and retail gasoline prices is very important to calculate the effects by subsidies. METI assumes lag of 2 weeks from Dubai to retailers (0 week from Dubai to wholesalers and 2 weeks from wholesalers to retailers), and normal margin `r normal_margin[3] %>% round(1)` yen per litre between Dubai and retail prices. However, the monthly data analysis in the previous chapter suggests that there usually is one month lag from Dubai to retailers, and that `r normal_margin[3] %>% round(1)` yen per litre gap between Dubai and retail prices is historically large. I hope I will find out whether METI's assumption is reasonable or not, while I update this page.

## Minor change of METI's effects calculation from March 14, 2022

METI changed calculation method from March 14, 2022. The new method is:

1.  Reset the last week counterfactual retail price without subsidy to the last week actual retail price plus subsidy.

2.  Add Dubai crude oil price change from the last week to this week to it, and you will get this week counterfactual retail price without subsidy.

I think this is a minor change, as METI basically continues to assume that retail prices will reflect subsidies 2 weeks later, and that there is 2 weeks lag between Dubai crude oil prices and retail prices.

```{r}

effects_lag2 <- effects %>% 
  filter(lag == 2) %>%
  mutate(
    subsidy = lag(subsidy, 2),
    subsidy = replace_na(subsidy, 0)
  )

p_old <- effects_lag2 %>% 
  pivot_longer(c(subsidy, effect_by_subsidy)) %>% 
  mutate(
    name = recode(name,
                  effect_by_subsidy = "Effect",
                  subsidy = "Subsidy")
  ) %>% 
  filter(week >= yearweek("2022 W11")) %>% 
  ggplot(aes(week, value, fill = name)) +
  geom_col(position = "identity", alpha = 0.5) +
  scale_fill_manual(values = c("red", "blue")) +
  scale_x_yearweek(date_labels = "%m/\n%d") +
  ylim(0, 40) +
  labs(x = NULL, y = "Yen per litre", fill = NULL,
       title = "Old method = lag 2") +
  theme(legend.position = "none")

# from METI, small disconnect of Dubai in 2022 W08
effects_lag2[effects_lag2$week == yearweek("2022 W08"), "dubai"] <- 71.5

p_new <- effects_lag2 %>% 
  mutate(
    reset_last_week = lag(actual + subsidy),
    dubai_diff = lag(dubai - lag(dubai), 2),
    effect = reset_last_week + dubai_diff - actual
  ) %>% 
  pivot_longer(c(subsidy, effect)) %>% 
  mutate(
    name = recode(name,
                  effect = "Effect",
                  subsidy = "Subsidy")
  ) %>% 
  filter(week >= yearweek("2022 W11")) %>% 
  ggplot(aes(week, value, fill = name)) +
  geom_col(position = "identity", alpha = 0.5) +
  scale_fill_manual(values = c("red", "blue")) +
  scale_x_yearweek(date_labels = "%m/\n%d") +
  ylim(0, 40) +
  labs(x = NULL, y = NULL, fill = NULL,
       title = "New method")

p_old | p_new

```

EOL
